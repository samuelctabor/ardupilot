// Copyright (c) Microsoft Corporation. All rights reserved. 
// Licensed under the GPLv3 license

#pragma once

#define SG_FILTER_C C41_3
#define SG_FILTER_SIZE 41 

class VarioSavitzkyGolayFilter
{
private:
    const float C41_3[4][41] = { { -0.0323312535451, -0.023823028928, -0.015751123522, -0.00811553732711, -0.000916270343383, 0.00584667742921, 0.0121733059907, 0.018063615341, 0.0235176054802, 0.0285352764082, 0.0331166281251, 0.0372616606309, 0.0409703739256, 0.0442427680091, 0.0470788428815, 0.0494785985427, 0.0514420349928, 0.0529691522318, 0.0540599502596, 0.0547144290763, 0.0549325886819, 0.0547144290763, 0.0540599502596, 0.0529691522318, 0.0514420349928, 0.0494785985427, 0.0470788428815, 0.0442427680091, 0.0409703739256, 0.0372616606309, 0.0331166281251, 0.0285352764082, 0.0235176054802, 0.018063615341, 0.0121733059907, 0.00584667742921, -0.000916270343383, -0.00811553732711, -0.015751123522, -0.023823028928, -0.0323312535451 },
    { 0.00733573478894 , 0.00426393421288 , 0.00160828961169 , -0.000653101960682 , -0.00254214345028 , -0.00408073780316 , -0.00529078796536 , -0.00619419688292 , -0.00681286750188 , -0.00716870276831 , -0.00728360562823 , -0.0071794790277 , -0.00687822591277 , -0.00640174922947 , -0.00577195192385 , -0.00501073694195 , -0.00414000722984 , -0.00318166573354 , -0.0021576153991 , -0.00108975917257 , 0.0 , 0.00108975917257 , 0.0021576153991 , 0.00318166573354 , 0.00414000722984 , 0.00501073694195 , 0.00577195192385 , 0.00640174922947 , 0.00687822591277 , 0.0071794790277 , 0.00728360562823 , 0.00716870276831 , 0.00681286750188 , 0.00619419688292 , 0.00529078796536 , 0.00408073780316 , 0.00254214345028 , 0.000653101960682 , -0.00160828961169 , -0.00426393421288 , -0.00733573478894 },
    { 0.000405153553197 , 0.000344380520217 , 0.000286724053031 , 0.00023218415164 , 0.000180760816042 , 0.000132454046237 , 8.7263842227e-05 , 4.51902040104e-05 , 6.23313158764e-06 , -2.96073750413e-05 , -6.23313158764e-05 , -9.19386909177e-05 , -0.000118429500165 , -0.000141803743619 , -0.000162061421279 , -0.000179202533145 , -0.000193227079217 , -0.000204135059495 , -0.00021192647398 , -0.000216601322671 , -0.000218159605567 , -0.000216601322671 , -0.00021192647398 , -0.000204135059495 , -0.000193227079217 , -0.000179202533145 , -0.000162061421279 , -0.000141803743619 , -0.000118429500165 , -9.19386909177e-05 , -6.23313158764e-05 , -2.96073750413e-05 , 6.23313158764e-06 , 4.51902040104e-05 , 8.7263842227e-05 , 0.000132454046237 , 0.000180760816042 , 0.00023218415164 , 0.000286724053031 , 0.000344380520217 , 0.000405153553197 },
    { -4.29708313996e-05 , -3.00795819798e-05 , -1.88410568445e-05 , -9.16827050511e-06 , -9.74237473028e-07 , 5.82802774044e-06 , 1.1325510624e-05 , 1.56051966662e-05 , 1.87540713558e-05 , 2.08591201814e-05 , 2.20073286318e-05 , 2.22856821955e-05 , 2.17811663613e-05 , 2.05807666177e-05 , 1.87714684535e-05 , 1.64402573574e-05 , 1.36741188179e-05 , 1.05600383237e-05 , 7.18500136358e-06 , 3.63599342612e-06 , 0.0 , -3.63599342612e-06 , -7.18500136358e-06 , -1.05600383237e-05 , -1.36741188179e-05 , -1.64402573574e-05 , -1.87714684535e-05 , -2.05807666177e-05 , -2.17811663613e-05 , -2.22856821955e-05 , -2.20073286318e-05 , -2.08591201814e-05 , -1.87540713558e-05 , -1.56051966662e-05 , -1.1325510624e-05 , -5.82802774044e-06 , 9.74237473028e-07 , 9.16827050511e-06 , 1.88410568445e-05 , 3.00795819798e-05 , 4.29708313996e-05 } };

    const float C81_3[4][81] = { { -0.0174029451138 , -0.0151717983043 , -0.0129971362242 , -0.0108789588735 , -0.00881726625207 , -0.00681205836002 , -0.00486333519733 , -0.00297109676399 , -0.00113534306 , 0.000643925914629 , 0.00236671015991 , 0.00403300967583 , 0.00564282446241 , 0.00719615451963 , 0.00869299984749 , 0.010133360446 , 0.0115172363152 , 0.012844627455 , 0.0141155338654 , 0.0153299555465 , 0.0164878924983 , 0.0175893447207 , 0.0186343122137 , 0.0196227949774 , 0.0205547930117 , 0.0214303063167 , 0.0222493348923 , 0.0230118787386 , 0.0237179378555 , 0.0243675122431 , 0.0249606019013 , 0.0254972068301 , 0.0259773270296 , 0.0264009624998 , 0.0267681132406 , 0.027078779252 , 0.0273329605341 , 0.0275306570869 , 0.0276718689102 , 0.0277565960043 , 0.0277848383689 , 0.0277565960043 , 0.0276718689102 , 0.0275306570869 , 0.0273329605341 , 0.027078779252 , 0.0267681132406 , 0.0264009624998 , 0.0259773270296 , 0.0254972068301 , 0.0249606019013 , 0.0243675122431 , 0.0237179378555 , 0.0230118787386 , 0.0222493348923 , 0.0214303063167 , 0.0205547930117 , 0.0196227949774 , 0.0186343122137 , 0.0175893447207 , 0.0164878924983 , 0.0153299555465 , 0.0141155338654 , 0.012844627455 , 0.0115172363152 , 0.010133360446 , 0.00869299984749 , 0.00719615451963 , 0.00564282446241 , 0.00403300967583 , 0.00236671015991 , 0.000643925914629 , -0.00113534306 , -0.00297109676399 , -0.00486333519733 , -0.00681205836002 , -0.00881726625207 , -0.0108789588735 , -0.0129971362242 , -0.0151717983043 , -0.0174029451138 },
    { 0.00207091539902 , 0.00164736029333 , 0.00125204181199 , 0.000884235938997 , 0.000543218658347 , 0.000228265954028 , -6.13461899689e-05 , -0.000326341789653 , -0.000567444861034 , -0.00078537942012 , -0.000980869482921 , -0.00115463906545 , -0.00130741218371 , -0.00143991285371 , -0.00155286509146 , -0.00164699291297 , -0.00172302033426 , -0.00178167137132 , -0.00182367004017 , -0.00184974035682 , -0.00186060633728 , -0.00185699199755 , -0.00183962135365 , -0.00180921842158 , -0.00176650721735 , -0.00171221175698 , -0.00164705605647 , -0.00157176413183 , -0.00148705999907 , -0.00139366767421 , -0.00129231117324 , -0.00118371451218 , -0.00106860170703 , -0.000947696773813 , -0.000821723728531 , -0.000691406587193 , -0.00055746936581 , -0.000420636080389 , -0.000281630746942 , -0.000141177381475 , 0.0 , 0.000141177381475 , 0.000281630746942 , 0.000420636080389 , 0.00055746936581 , 0.000691406587193 , 0.000821723728531 , 0.000947696773813 , 0.00106860170703 , 0.00118371451218 , 0.00129231117324 , 0.00139366767421 , 0.00148705999907 , 0.00157176413183 , 0.00164705605647 , 0.00171221175698 , 0.00176650721735 , 0.00180921842158 , 0.00183962135365 , 0.00185699199755 , 0.00186060633728 , 0.00184974035682 , 0.00182367004017 , 0.00178167137132 , 0.00172302033426 , 0.00164699291297 , 0.00155286509146 , 0.00143991285371 , 0.00130741218371 , 0.00115463906545 , 0.000980869482921 , 0.00078537942012 , 0.000567444861034 , 0.000326341789653 , 6.13461899689e-05 , -0.000228265954028 , -0.000543218658347 , -0.000884235938997 , -0.00125204181199 , -0.00164736029333 , -0.00207091539902 },
    { 5.44182148649e-05 , 5.033684875e-05 , 4.63588083596e-05 , 4.24840936936e-05 , 3.8712704752e-05 , 3.50446415348e-05 , 3.14799040421e-05 , 2.80184922738e-05 , 2.46604062299e-05 , 2.14056459105e-05 , 1.82542113154e-05 , 1.52061024448e-05 , 1.22613192987e-05 , 9.41986187693e-06 , 6.68173017961e-06 , 4.04692420672e-06 , 1.51544395826e-06 , -9.12710565772e-07 , -3.23753936538e-06 , -5.45904244056e-06 , -7.57721979131e-06 , -9.59207141764e-06 , -1.15035973195e-05 , -1.3311797497e-05 , -1.50166719501e-05 , -1.66182206787e-05 , -1.81164436829e-05 , -1.95113409626e-05 , -2.0802912518e-05 , -2.19911583489e-05 , -2.30760784554e-05 , -2.40576728374e-05 , -2.4935941495e-05 , -2.57108844282e-05 , -2.6382501637e-05 , -2.69507931214e-05 , -2.74157588813e-05 , -2.77773989168e-05 , -2.80357132279e-05 , -2.81907018145e-05 , -2.82423646767e-05 , -2.81907018145e-05 , -2.80357132279e-05 , -2.77773989168e-05 , -2.74157588813e-05 , -2.69507931214e-05 , -2.6382501637e-05 , -2.57108844282e-05 , -2.4935941495e-05 , -2.40576728374e-05 , -2.30760784554e-05 , -2.19911583489e-05 , -2.0802912518e-05 , -1.95113409626e-05 , -1.81164436829e-05 , -1.66182206787e-05 , -1.50166719501e-05 , -1.3311797497e-05 , -1.15035973195e-05 , -9.59207141764e-06 , -7.57721979131e-06 , -5.45904244056e-06 , -3.23753936538e-06 , -9.12710565772e-07 , 1.51544395826e-06 , 4.04692420672e-06 , 6.68173017961e-06 , 9.41986187693e-06 , 1.22613192987e-05 , 1.52061024448e-05 , 1.82542113154e-05 , 2.14056459105e-05 , 2.46604062299e-05 , 2.80184922738e-05 , 3.14799040421e-05 , 3.50446415348e-05 , 3.8712704752e-05 , 4.24840936936e-05 , 4.63588083596e-05 , 5.033684875e-05 , 5.44182148649e-05 },
    { -3.02323415916e-06 , -2.56974903529e-06 , -2.14496550153e-06 , -1.74814761969e-06 , -1.37855945154e-06 , -1.03546505889e-06 , -7.18128503532e-07 , -4.25813847247e-07 , -1.57785151832e-07 , 8.66935209224e-08 , 3.08358109223e-07 , 5.07944551279e-07 , 6.86188785297e-07 , 8.43826749487e-07 , 9.81594382056e-07 , 1.10022762121e-06 , 1.20046240517e-06 , 1.28303467212e-06 , 1.34868036029e-06 , 1.39813540788e-06 , 1.4321357531e-06 , 1.45141733415e-06 , 1.45671608925e-06 , 1.4487679566e-06 , 1.42830887442e-06 , 1.3960747809e-06 , 1.35280161426e-06 , 1.2992253127e-06 , 1.23608181444e-06 , 1.16410705768e-06 , 1.08403698063e-06 , 9.96607521503e-07 , 9.02554618499e-07 , 8.0261420983e-07 , 6.97522233703e-07 , 5.88014628327e-07 , 4.74827331911e-07 , 3.58696282662e-07 , 2.40357418788e-07 , 1.20546678498e-07 , 0.0 , -1.20546678498e-07 , -2.40357418788e-07 , -3.58696282662e-07 , -4.74827331911e-07 , -5.88014628327e-07 , -6.97522233703e-07 , -8.0261420983e-07 , -9.02554618499e-07 , -9.96607521503e-07 , -1.08403698063e-06 , -1.16410705768e-06 , -1.23608181444e-06 , -1.2992253127e-06 , -1.35280161426e-06 , -1.3960747809e-06 , -1.42830887442e-06 , -1.4487679566e-06 , -1.45671608925e-06 , -1.45141733415e-06 , -1.4321357531e-06 , -1.39813540788e-06 , -1.34868036029e-06 , -1.28303467212e-06 , -1.20046240517e-06 , -1.10022762121e-06 , -9.81594382056e-07 , -8.43826749487e-07 , -6.86188785297e-07 , -5.07944551279e-07 , -3.08358109223e-07 , -8.66935209224e-08 , 1.57785151832e-07 , 4.25813847247e-07 , 7.18128503532e-07 , 1.03546505889e-06 , 1.37855945154e-06 , 1.74814761969e-06 , 2.14496550153e-06 , 2.56974903529e-06 , 3.02323415916e-06 } };

    const int _c_m = SG_FILTER_SIZE;
    const float _c_z = SG_FILTER_SIZE / 2 - 1;

public:
    VarioSavitzkyGolayFilter(void) {}
    void prediction(float dt, const float **ekf_buffer, unsigned ekf_buffer_size, unsigned ekf_buffer_ptr, float *Edot, float *Edotdot);
};